<!DOCTYPE html>
<html lang="en">
<head>
  <script>
/* Draw the Trends chart as inline SVG (no extra library needed). */
(function () {
  // Keep any existing populateInsightsFrom but add chart drawing.
  const _old = window.populateInsightsFrom;
  window.populateInsightsFrom = function (data) {
    if (typeof _old === 'function') { try { _old(data); } catch(e){} }

    // Ensure we have a place to draw just under the "Trends" heading
    let heading = Array.from(document.querySelectorAll('h1,h2,h3,div'))
      .find(el => (el.textContent || '').trim() === 'Trends');
    if (!heading) return;

    let mount = document.getElementById('trendSvg');
    if (!mount) {
      mount = document.createElement('div');
      mount.id = 'trendSvg';
      mount.style.padding = '8px 6px 12px';
      heading.insertAdjacentElement('afterend', mount);
    }

    const byDay = data.byDay || {};
    const days = Object.keys(byDay).sort();
    const vals = days.map(d => byDay[d]);
    if (!days.length) { mount.innerHTML = '<div style="color:#64748B;font-size:12px">No data yet.</div>'; return; }

    const W = Math.max(300, 60*(days.length-1) + 40), H = 220, P = 24;
    const max = Math.max(...vals), min = 0;
    const X = i => P + (W - 2*P) * (i / Math.max(1, days.length-1));
    const Y = v => H - P - (H - 2*P) * ((v - min) / Math.max(1, max - min));

    let path = '';
    vals.forEach((v,i)=> path += (i ? ' L' : 'M') + X(i) + ' ' + Y(v));
    const dots = vals.map((v,i)=> `<circle cx="${X(i)}" cy="${Y(v)}" r="3"/>`).join('');

    mount.innerHTML = `
      <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}">
        <rect x="0" y="0" width="${W}" height="${H}" fill="#ffffff"/>
        <path d="${path}" fill="none" stroke="#2563EB" stroke-width="2"/>
        ${dots}
      </svg>
      <div style="font-size:12px;color:#64748B;margin-top:4px;">${days.join(' · ')}</div>`;
  };
})();
</script>  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR1.tech — Create & Track Beautiful QR Codes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{--bg:#F8FAFC;--panel:#FFFFFF;--border:#E2E8F0;--text:#0F172A;--mute:#64748B}
    html,body{height:100%;font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;color:var(--text)}
    .container-lg{max-width:1100px;margin:0 auto;padding:0 1rem}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 20px rgba(15,23,42,.06)}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.6rem 1rem;border-radius:12px;border:1px solid var(--border);background:#fff;font-weight:600}
    .btn.btn-primary{background:#2563EB;color:#fff;border-color:#1D4ED8}
    .nav-link{border-radius:12px;padding:.5rem .75rem}
    .nav-link.active{background:#EAF2FF;color:#1E40AF}
  </style>
  <script>
/* Add Trends chart automatically when live data loads — no extra HTML needed. */
window.populateInsightsFrom = async function (data) {
  // Cards
  const best = Object.entries(data.byHour || {}).sort((a,b)=>b[1]-a[1])[0];
  const tEl = document.getElementById('insightTime');
  if (tEl) tEl.textContent = best ? `${best[0]}:00–${(Number(best[0])+1)%24}:00` : '—';

  const top = Object.entries(data.byCity || {}).sort((a,b)=>b[1]-a[1])[0];
  const cEl = document.getElementById('insightCity');
  if (cEl) cEl.textContent = top ? `${top[0]} (${top[1]})` : '—';

  // Ensure a canvas exists right under the "Trends" heading
  function ensureCanvas() {
    let cv = document.getElementById('chartTrends');
    if (!cv) {
      const heading = Array.from(document.querySelectorAll('h1,h2,h3,div'))
        .find(el => (el.textContent || '').trim() === 'Trends');
      if (heading) {
        cv = document.createElement('canvas');
        cv.id = 'chartTrends';
        cv.className = 'mt-3';
        heading.insertAdjacentElement('afterend', cv);
      }
    }
    return cv;
  }

  function drawChart() {
    const labels = Object.keys(data.byDay || {}).sort();
    const cv = ensureCanvas();
    if (!cv || !labels.length) return;

    if (window.chartTrends) window.chartTrends.destroy();
    window.chartTrends = new Chart(cv, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Scans', data: labels.map(k => data.byDay[k]) }] },
      options: { plugins: { legend: { display: false } }, elements: { line: { tension: .35 } } }
    });
  }

  // Load Chart.js if it isn’t loaded yet, then draw
  if (typeof Chart === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
    s.onload = drawChart;
    document.head.appendChild(s);
  } else {
    drawChart();
  }
};
    <script>
/* Add a Trends line chart without relying on where other code is.
   This listens for clicks on the "Use Live Data" button anywhere on the page,
   fetches the live insights, and draws an inline SVG chart below the buttons. */
document.addEventListener('click', async (e) => {
  if (!e.target || e.target.id !== 'liveBtn') return;

  const urls = [
    '/.netlify/functions/insights',
    'https://qr1.tech/.netlify/functions/insights',
    'https://endearing-genie-16371b.netlify.app/.netlify/functions/insights'
  ];

  let data = null;
  for (const u of urls) {
    try {
      const r = await fetch(u, { cache: 'no-store' });
      if (r.ok) { data = await r.json(); break; }
    } catch {}
  }
  if (!data) { alert('Trend data not reachable.'); return; }

  // Find the button area and create a mount right below it
  const btn = document.getElementById('liveBtn');
  const container = btn && btn.parentNode ? btn.parentNode : document.body;

  let mount = document.getElementById('trendMount');
  if (!mount) {
    mount = document.createElement('div');
    mount.id = 'trendMount';
    mount.style.marginTop = '12px';
    mount.style.border = '1px solid #E2E8F0';
    mount.style.borderRadius = '12px';
    mount.style.padding = '12px';
    mount.style.background = '#fff';
    container.insertAdjacentElement('afterend', mount);
  }

  const byDay = data.byDay || {};
  const days = Object.keys(byDay).sort();
  if (!days.length) { mount.innerHTML = '<div style="color:#64748B;font-size:12px">No data yet.</div>'; return; }
  const vals = days.map(d => byDay[d]);

  const W = Math.max(320, 60*(days.length-1) + 40), H = 220, P = 24;
  const max = Math.max(...vals) || 1;
  const X = i => P + (W - 2*P) * (i / Math.max(1, days.length-1));
  const Y = v => H - P - (H - 2*P) * (v / max);

  let d = '';
  vals.forEach((v,i)=> d += (i ? ' L' : 'M') + X(i) + ' ' + Y(v));
  const dots = vals.map((v,i)=> `<circle cx="${X(i)}" cy="${Y(v)}" r="3" fill="#2563EB"/>`).join('');

  mount.innerHTML =
    `<div style="font-weight:600;margin-bottom:6px">Trends</div>
     <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}">
       <rect width="${W}" height="${H}" fill="#ffffff"/>
       <path d="${d}" stroke="#2563EB" stroke-width="2" fill="none"/>
       ${dots}
     </svg>
     <div style="font-size:12px;color:#64748B;margin-top:4px;">${days.join(' · ')}</div>`;
});
</script>
  <script>
/* Force-replace the "Use Live Data" click so it never shows the old alert.
   Works on load and whenever you navigate (#/insights). Draws an SVG trend line. */
(function(){
  async function fetchInsights(){
    // Use your confirmed-working endpoint:
    const r = await fetch('https://qr1.tech/.netlify/functions/insights', { cache:'no-store' });
    if (!r.ok) throw new Error('insights failed');
    return r.json();
  }

  function drawTrends(data){
    // Find a place to show the chart: right under the buttons row
    const btn = document.getElementById('liveBtn');
    if (!btn || !btn.parentNode) return;
    let mount = document.getElementById('trendMount');
    if (!mount){
      mount = document.createElement('div');
      mount.id = 'trendMount';
      mount.style.marginTop = '12px';
      mount.style.border = '1px solid #E2E8F0';
      mount.style.borderRadius = '12px';
      mount.style.padding = '12px';
      mount.style.background = '#fff';
      btn.parentNode.insertAdjacentElement('afterend', mount);
    }

    const byDay = data.byDay || {};
    const days = Object.keys(byDay).sort();
    if (!days.length){ mount.innerHTML = '<div style="color:#64748B;font-size:12px">No data yet.</div>'; return; }
    const vals = days.map(d => byDay[d]);

    const W = Math.max(320, 60*(days.length-1)+40), H = 220, P = 24;
    const max = Math.max(...vals) || 1;
    const X = i => P + (W-2*P) * (i / Math.max(1, days.length-1));
    const Y = v => H-P - (H-2*P) * (v / max);

    let d = '';
    vals.forEach((v,i)=> d += (i?' L':' M') + X(i) + ' ' + Y(v));
    const dots = vals.map((v,i)=> `<circle cx="${X(i)}" cy="${Y(v)}" r="3" fill="#2563EB"/>`).join('');

    mount.innerHTML =
      `<div style="font-weight:600;margin-bottom:6px">Trends</div>
       <svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}">
         <rect width="${W}" height="${H}" fill="#ffffff"/>
         <path d="${d.trim()}" stroke="#2563EB" stroke-width="2" fill="none"/>
         ${dots}
       </svg>
       <div style="font-size:12px;color:#64748B;margin-top:4px;">${days.join(' · ')}</div>`;
  }

  function updateCards(data){
    const best = Object.entries(data.byHour||{}).sort((a,b)=>b[1]-a[1])[0];
    const tEl = document.getElementById('insightTime');
    if (tEl) tEl.textContent = best ? `${best[0]}:00–${(Number(best[0])+1)%24}:00` : '—';
    const top = Object.entries(data.byCity||{}).sort((a,b)=>b[1]-a[1])[0];
    const cEl = document.getElementById('insightCity');
    if (cEl) cEl.textContent = top ? `${top[0]} (${top[1]})` : '—';
  }

  function attach(){
    // Wait a tick for the Insights page to be visible
    setTimeout(()=>{
      const oldBtn = document.getElementById('liveBtn');
      if (!oldBtn || !oldBtn.parentNode) return;

      // Replace the button node to remove ANY old listeners
      const btn = oldBtn.cloneNode(true);
      oldBtn.parentNode.replaceChild(btn, oldBtn);

      btn.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        try{
          const data = await fetchInsights();
          updateCards(data);
          drawTrends(data);
        }catch(e){
          alert('Live data endpoint unreachable.');
        }
      }, true);
    }, 50);
  }

  // Run on load and on route changes
  window.addEventListener('DOMContentLoaded', attach);
  window.addEventListener('hashchange', ()=>{
    if (location.hash.startsWith('#/insights')) attach();
  });
})();
</script>
</script></head>
<body class="bg-[var(--bg)]">
<header class="border-b border-[var(--border)] bg-white sticky top-0 z-40">
  <div class="container-lg flex items-center justify-between py-3">
    <a href="#/home" class="flex items-center gap-3">
      <div class="text-sm tracking-wide text-[var(--mute)]">qr1.tech</div>
      <div class="font-semibold leading-4">Create & Track Beautiful QR Codes</div>
    </a>
    <nav class="flex items-center gap-1">
      <a data-nav="#/home" class="nav-link">Home</a>
      <a data-nav="#/builder" class="nav-link">Create QR</a>
      <a data-nav="#/templates" class="nav-link">Templates</a>
      <a data-nav="#/track" class="nav-link">Track Scans</a>
      <a data-nav="#/insights" class="nav-link">AI Insights</a>
    </nav>
  </div>
</header>

<main class="container-lg py-8">
  <section id="page-insights" data-page>
    <h2 class="text-2xl font-semibold">AI‑Powered Insights</h2>
    <p class="text-[var(--mute)] text-sm mt-1">Use live server data or upload a CSV.</p>
    <div class="mt-3 flex gap-2 flex-wrap">
      <button id="liveBtn" class="btn btn-primary">Use Live Data</button>
      <a class="btn" href="/.netlify/functions/export-csv">Download CSV</a>
    </div>

    <div class="grid md:grid-cols-2 gap-4 mt-5">
      <div class="card p-4">
        <div class="text-sm text-[var(--mute)]">Best Time to Post</div>
        <div id="insightTime" class="mt-2 font-semibold">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-[var(--mute)]">Top City</div>
        <div id="insightCity" class="mt-2 font-semibold">—</div>
      </div>
    </div>

    <div class="card p-5 mt-4">
      <h3 class="font-semibold">Trends</h3>
      <canvas id="chartTrends" class="mt-3"></canvas>
    </div>

    <div class="card p-5 mt-4">
      <h3 class="font-semibold">Upload CSV instead</h3>
      <input id="csvInput" type="file" accept=".csv" class="w-full border border-[var(--border)] rounded-xl p-2" />
      <div id="askOut" class="text-sm mt-3 text-[var(--mute)]">Upload or use live data to see insights.</div>
    </div>
  </section>
</main>

<script>
  const pages = Array.from(document.querySelectorAll('[data-page]'));
  const navLinks = Array.from(document.querySelectorAll('[data-nav]'));
  function route(){ pages.forEach(p=>p.classList.add('hidden'));
    const hash = location.hash || '#/insights';
    const pageId = 'page-'+hash.replace('#/','');
    const el = document.getElementById(pageId) || document.getElementById('page-insights');
    el.classList.remove('hidden');
    document.querySelectorAll('.nav-link').forEach(a=>a.classList.remove('active'));
    const nav = document.querySelector(`[data-nav="${hash}"]`);
    if(nav) nav.classList.add('active');
  }
  window.addEventListener('hashchange', route);
  navLinks.forEach(a=> a.href=a.dataset.nav);
  route();

  function populateInsightsFrom(data){
    const best = Object.entries(data.byHour || {}).sort((a,b)=>b[1]-a[1])[0];
    const tEl = document.getElementById('insightTime');
    if (tEl) tEl.textContent = best ? `${best[0]}:00–${(Number(best[0])+1)%24}:00` : '—';

    const top = Object.entries(data.byCity || {}).sort((a,b)=>b[1]-a[1])[0];
    const cEl = document.getElementById('insightCity');
    if (cEl) cEl.textContent = top ? `${top[0]} (${top[1]})` : '—';

    const labels = Object.keys(data.byDay || {}).sort();
    const cv = document.getElementById('chartTrends');
    if (cv && window.Chart) {
      if (window.chartTrends) window.chartTrends.destroy();
      window.chartTrends = new Chart(cv, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Scans', data: labels.map(k => data.byDay[k]) }] },
        options: { plugins: { legend: { display: false } }, elements: { line: { tension: .35 } } }
      });
    }
  }

  (function attachLiveBtn(){
    const btn = document.getElementById('liveBtn');
    if (!btn) return;
    btn.addEventListener('click', async () => {
      try {
        const res = await fetch('/.netlify/functions/insights');
        const data = await res.json();
        populateInsightsFrom(data);
      } catch {
        alert('Could not load live data yet. Make a scan first on the Track page.');
      }
    });
  })();

  // Optional: simple CSV upload to compute the same insights client-side
  document.getElementById('csvInput').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    const rows = text.trim().split('\n').slice(1).map(l=>{
      const [ts,city,device,campaign] = l.split(',');
      return { ts, city, device, campaign };
    });
    const byHour={},byDay={},byCity={};
    rows.forEach(r=>{
      const t = new Date(r.ts); const h=t.getHours();
      byHour[h]=(byHour[h]||0)+1;
      const d=r.ts.slice(0,10); byDay[d]=(byDay[d]||0)+1;
      const c=r.city||'Unknown'; byCity[c]=(byCity[c]||0)+1;
    });
    populateInsightsFrom({byHour,byDay,byCity});
  });
</script><script>
/* Replace the Live Data button handler with a more reliable one that
   tries your custom domain and your Netlify subdomain as fallbacks. */
(function () {
  let btn = document.getElementById('liveBtn');
  if (!btn) return;

  // Remove any old handlers by cloning the button
  const clone = btn.cloneNode(true);
  btn.parentNode.replaceChild(clone, btn);
  btn = clone;

  btn.addEventListener('click', async () => {
    const endpoints = [
      '/.netlify/functions/insights',
      'https://qr1.tech/.netlify/functions/insights',
      'https://endearing-genie-16371b.netlify.app/.netlify/functions/insights'
    ];

    <script>
/* Draw the Trends chart after you click "Use Live Data" (no libraries). */
(function(){
  const btn = document.getElementById('liveBtn');
  if(!btn) return;

  // Add an extra handler (keeps your current one). It fetches and draws the chart.
  btn.addEventListener('click', async ()=>{
    const urls = [
      '/.netlify/functions/insights',
      'https://qr1.tech/.netlify/functions/insights',
      'https://endearing-genie-16371b.netlify.app/.netlify/functions/insights'
    ];

    let data = null;
    for (const u of urls) {
      try { const r = await fetch(u, { cache:'no-store' }); if (r.ok) { data = await r.json(); break; } } catch {}
    }
    if (!data) return;

    // Find the "Trends" header and mount area
    const heading = Array.from(document.querySelectorAll('h1,h2,h3,div'))
      .find(el => (el.textContent || '').trim() === 'Trends');
    if (!heading) return;

    let mount = document.getElementById('trendSvg');
    if (!mount) {
      mount = document.createElement('div');
      mount.id = 'trendSvg';
      mount.style.padding = '8px 6px 12px';
      heading.insertAdjacentElement('afterend', mount);
    }

    // Build a tiny inline SVG line chart
    const days = Object.keys(data.byDay || {}).sort();
    const vals = days.map(d => data.byDay[d]);
    if (!days.length) { mount.innerHTML = '<div style="color:#64748B;font-size:12px">No data yet.</div>'; return; }

    const W = Math.max(320, 60*(days.length-1) + 40), H = 220, P = 24;
    const max = Math.max(...vals) || 1;
    const X = i => P + (W - 2*P) * (i / Math.max(1, days.length-1));
    const Y = v => H - P - (H - 2*P) * (v / max);

    let d = '';
    vals.forEach((v,i)=> d += (i ? ' L' : 'M') + X(i) + ' ' + Y(v));
    const dots = vals.map((v,i)=> `<circle cx="${X(i)}" cy="${Y(v)}" r="3" fill="#2563EB"/>`).join('');

    mount.innerHTML =
      `<svg viewBox="0 0 ${W} ${H}" width="100%" height="${H}">
         <rect width="${W}" height="${H}" fill="#ffffff"/>
         <path d="${d}" stroke="#2563EB" stroke-width="2" fill="none"/>
         ${dots}
       </svg>
       <div style="font-size:12px;color:#64748B;margin-top:4px;">${days.join(' · ')}</div>`;
  });
})();
</script>
    let data = null;
    for (const url of endpoints) {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (res.ok) { data = await res.json(); break; }
      } catch {}
    }

    if (!data) {
      alert('Live data endpoint unreachable.');
      return;
    }

    if (typeof populateInsightsFrom === 'function') {
      populateInsightsFrom(data);
    }
  });
})();

<script>
(function () {
  function norm(txt) { return (txt || '').trim().toLowerCase(); }

  function cleanTrends() {
    // Find all cards titled "Trends" (h2/h3/h4 just in case)
    const heads = Array.from(document.querySelectorAll('.card h2, .card h3, .card h4'));
    const cards = heads
      .filter(h => norm(h.textContent) === 'trends')
      .map(h => h.closest('.card'))
      .filter(Boolean);

    if (cards.length <= 1) return;

    // Prefer the one that actually contains a chart-like element
    const withChart = cards.find(c =>
      c.querySelector('canvas, svg, [data-chart], [data-rechart], [role="img"][aria-label*="chart"]')
    );

    const keep = withChart || cards[0];
    cards.forEach(c => { if (c !== keep) c.remove(); });
  }

  // Run now and whenever the DOM changes (e.g., after "Use Live Data")
  document.addEventListener('DOMContentLoaded', cleanTrends);
  new MutationObserver(cleanTrends).observe(document.body, { childList: true, subtree: true });

  // Extra nudge after clicking the "Use Live Data" button
  document.addEventListener('click', (e) => {
    if (norm(e.target?.textContent).includes('use live data')) {
      setTimeout(cleanTrends, 300);
      setTimeout(cleanTrends, 1000);
    }
  });
})();
</script>
  <script>
(function () {
  // Keep only the first "Trends" card that actually contains a chart
  function cleanTrends() {
    // Find any card whose heading *looks like* "Trends"
    const cards = Array.from(document.querySelectorAll('.card'))
      .filter(c => {
        const head = c.querySelector('h1,h2,h3,h4,h5,[data-title],[class*="title"],[class*="heading"]');
        const txt = (head?.textContent || '')
          .replace(/\s+/g, ' ')
          .trim()
          .toLowerCase();
        return txt.startsWith('trends'); // tolerant match
      });

    if (cards.length <= 1) return;

    // Prefer the one that actually has a chart-like element
    const withChart =
      cards.find(c =>
        c.querySelector('canvas, svg, [data-chart], [data-rechart], [role="img"][aria-label*="chart"]')
      ) || cards[0];

    // Remove the rest (not just hide)
    cards.forEach(c => { if (c !== withChart) c.remove(); });
  }

  // Run on first render
  document.addEventListener('DOMContentLoaded', cleanTrends);

  // Run again after clicking "Use Live Data" (it re-renders the section)
  document.addEventListener('click', (e) => {
    const label = (e.target.closest('button,a,[role="button"]')?.textContent || '').toLowerCase();
    if (label.includes('use live data')) {
      setTimeout(cleanTrends, 300);
      setTimeout(cleanTrends, 800);
      setTimeout(cleanTrends, 1500);
    }
  });

  // Safety net: if the DOM mutates later, re-apply automatically
  new MutationObserver(() => cleanTrends())
    .observe(document.body, { childList: true, subtree: true });
})();
</script>
</body>
</html>
